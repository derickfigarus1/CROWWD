<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookevent</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="/style3.css">
</head>

<body>
  <header class="container-fluid d-flex justify-content-start align-items-center py-4">
    <div class="d-flex align-items-center me-auto ">
      <a href="#" class="text-decoration-none d-flex align-items-center">
        <h1 class="me-5">crowwd</h1>
      </a>
      <form class="d-flex me-3" action="/search-events" method="POST">
        <input class="form-control me-2" type="search" placeholder="Search for events,locations.." aria-label="Search"
          id="searchInput" name="searchQuery">
        <button class="btn btn-outline-success " type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
      </form>
    </div>
    <div class="me-4 ms-lg-auto ms-lg-5 justify-content-lg-start">
      <form class="d-none d-lg-flex me-lg-5 ms-lg-auto" action="/search-events-by-date-and-location" method="POST">
        <div class="input-group">
          <label id="date-header" for="from-date" class="me-2">From :</label>
          <input type="date" class="form-control me-2" id="from-date" name="fromDate">
          <label id="date-header" for="to-date" class="me-2">To :</label>
          <input type="date" class="form-control me-2" id="to-date" name="toDate">
          <label id="date-header" for="select-location" class="me-2">Select location </label>
          <select id="to-date" class="form-select me-2" name="location" id="cities">
            <option value="Alappuzha">Alappuzha</option>
            <option value="Thrissur">Thrissur</option>
            <option value="Palakkad">Palakkad</option>
            <option value="Malappuram">Malappuram</option>
            <option value="Manjeri">Manjeri</option>
            <option value="Thalassery">Thalassery</option>
            <option value="Kannur">Kannur</option>
            <option value="Kasaragod">Kasaragod</option>
            <option value="Kollam">Kollam</option>
            <option value="Neyyattinkara">Neyyattinkara</option>
            <option value="Kottayam">Kottayam</option>
            <option value="Pala">Pala</option>
            <option value="Aluva">Aluva</option>
            <option value="Angamaly">Angamaly</option>
            <option value="Thodupuzha">Thodupuzha</option>
            <option value="Muvattupuzha">Muvattupuzha</option>
            <option value="Perumbavoor">Perumbavoor</option>
            <option value="Kothamangalam">Kothamangalam</option>
            <option value="Vaikom">Vaikom</option>
            <option value="Cherthala">Cherthala</option>
            <option value="Changanassery">Changanassery</option>
            <option value="Kozhencherry">Kozhencherry</option>
            <option value="Adoor">Adoor</option>
            <option value="Pathanamthitta">Pathanamthitta</option>
            <option value="Pandalam">Pandalam</option>
            <option value="Kayamkulam">Kayamkulam</option>
            <option value="Mavelikkara">Mavelikkara</option>
            <option value="Chengannur">Chengannur</option>
            <option value="Thiruvalla">Thiruvalla</option>
            <option value="Punalur">Punalur</option>
            <option value="Paravur">Paravur</option>
            <option value="Kochi">Kochi</option>
            <option value="Kozhikode">Kozhikode</option>
            <option value="Thiruvananthapuram">Thiruvananthapuram</option>
            <option value="Kollam">Kollam</option>
          </select>
        </div>
        <button class="btn btn-outline-success" type="submit" id="go">Go</button>
      </form>
    </div>
    <div class="d-none d-lg-flex align-items-center">
      <div id="myNav" class="overlay">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="overlay-content">
          <a href="/">Logout</a>
          <a href="/profile">Profile</a>
          <a href="/admin">List an event</a>
          <a href="#">Contact</a>
        </div>
      </div>
      <span id="sandwich" onclick="openNav()">&#9776;</span>
    </div>
  </header>


  <div class="container-booking">
    <form action="">
      <div class="row">
        <div class="col">
          <h3 class="title">
            <%= event.textbox4 %>
          </h3>
          <div class="inputBox" id="name1">
            <span>full name :</span>
            <input type="text" id="name" name="name" required>
          </div>
          <div class="inputBox" id="aadhar">
            <span>Enter your 12-digit Aadhaar number:</span>
            <input type="text" id="aadharNumber" name="aadharNumber" pattern="[0-9]{12}" required>
          </div>
          <div class="qty-input">
            <div class="three-elements">
              <button class="qty-count qty-count--minus" data-action="minus" type="button">-</button>
              <input class="product-qty" type="number" name="product-qty" min="1" max="5" value="0">
              <button class="qty-count qty-count--add" data-action="add" type="button" id="increase">+
              </button>

              
            </div>
          </div>
          <div>
            <p id="result"></p>

          </div>
        </div>
      </div>
      <button type="submit" value="book tickets" class="submit-btn" id="rzp-button1">Pay</button>
    </form>
  </div>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    var ticketPrice = '<%= event.ticketPrice %>';

  </script>

  <script>



    document.getElementById('rzp-button1').onclick = async function (e) {
      e.preventDefault();

      if (!validateForm()) {
        return; 
      } else {
        try {
          var quantity = document.querySelector('.product-qty').value;
          var totalAmount = parseFloat(ticketPrice * quantity).toFixed(2);
          var fullName = document.getElementById('name').value;
          var aadharNumber = document.getElementById('aadharNumber').value;
          var formattedAmount = Math.floor(totalAmount * 100); 
          let eventTicketPrice = formattedAmount; 
          let response = await fetch("http://localhost:5000/payment", {
            method: "POST",
            headers: {
              "Content-type": "application/json"
            },
            body: JSON.stringify({
              fullName: fullName,
              aadharNumber: aadharNumber,
              eventId: '<%= eventId %>', 
              amount: formattedAmount,
              quantity: quantity, 
            })
          }).catch(error => console.error('Fetch error:', error));

          let orderData = await response.json();

          console.log(orderData);

          if (orderData && orderData.order && orderData.order.amount) {
            var options = {
              "key": "rzp_test_xcex1XJYL2Csgs", 
              "amount": orderData.order.amount.toString(), 
              "currency": "INR",
              "order_id": orderData.id,
              "handler": async function (response) {
                let saveBookingResponse = await fetch("http://localhost:5000/saveBooking", {
                  method: "POST",
                  headers: {
                    "Content-type": "application/json"
                  },
                  body: JSON.stringify({
                    fullName: fullName,
                    aadharNumber: aadharNumber,
                    eventId: '<%= eventId %>',
                    amount: totalAmount,
                    quantity: quantity,
                  })
                }).catch(error => console.error('Fetch error:', error));

                let saveBookingData = await saveBookingResponse.json();
                console.log(saveBookingData);
              }, "prefill": { 
                "name":'<%= user.name %>' , 
                "email": '<%= user.email %>',
                "contact": '<%= user.contact %>' 
              },
              "notes": {
                "address": "Crowwd Corporate Office"
              },
              "theme": {
                "color": "#333"
              }

            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
          } else {
            console.error('Order data or amount is missing from the response');
          }
        } catch (error) {
          console.error('Error creating order:', error);
        }
      }
    }




    const totalTicketsElement = '<%= event.totalTickets %>';
    if (totalTicketsElement < 5) {
      document.querySelector('.product-qty').setAttribute('max', totalTicketsElement);
    } else {
      document.querySelector('.product-qty').setAttribute('max', 5);
    }





    var QtyInput = (function () {
      var $qtyInputs = $(".qty-input");

      if (!$qtyInputs.length) {
        return;
      }

      var $inputs = $qtyInputs.find(".product-qty");
      var $countBtn = $qtyInputs.find(".qty-count");
      var qtyMin = parseInt($inputs.attr("min"));
      var qtyMax = parseInt($inputs.attr("max"));

      $inputs.change(function () {
        var $this = $(this);
        var $minusBtn = $this.siblings(".qty-count--minus");
        var $addBtn = $this.siblings(".qty-count--add");
        var qty = parseInt($this.val());

        if (isNaN(qty) || qty <= qtyMin) {
          $this.val(qtyMin);
          $minusBtn.attr("disabled", true);
        } else {
          $minusBtn.attr("disabled", false);

          if (qty >= qtyMax) {
            $this.val(qtyMax);
            $addBtn.attr('disabled', true);
          } else {
            $this.val(qty);
            $addBtn.attr('disabled', false);
          }
        }
      });

      $countBtn.click(function () {
        var operator = this.dataset.action;
        var $this = $(this);
        var $input = $this.siblings(".product-qty");
        var qty = parseInt($input.val());

        if (operator == "add") {
          qty += 1;
          if (qty >= qtyMin + 1) {
            $this.siblings(".qty-count--minus").attr("disabled", false);
          }

          if (qty >= qtyMax) {
            $this.attr("disabled", true);
          }
        } else {
          qty = qty <= qtyMin ? qtyMin : (qty -= 1);

          if (qty == qtyMin) {
            $this.attr("disabled", true);
          }

          if (qty < qtyMax) {
            $this.siblings(".qty-count--add").attr("disabled", false);
          }
        }

        $input.val(qty);
      });
    })();





    function validateForm() {
      var name = document.getElementById('name').value;
      var aadharNumber = document.getElementById('aadharNumber').value;
      var productQty = document.querySelector('.product-qty').value;

      if (!name || !aadharNumber || productQty <= 0) {
        document.getElementById('result').textContent = 'Please fill out all fields';
        return false; // Prevent form submission
      }

      return true;
    }





  </script>
</body>

</html>